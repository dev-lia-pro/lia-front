# Lia Mobile Applications - Documentation

## Overview

This document describes how to build, test, and deploy Lia mobile applications for Android and iOS using Capacitor.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Project Structure](#project-structure)
- [Local Development](#local-development)
- [Building for Production](#building-for-production)
- [CI/CD Pipeline](#cicd-pipeline)
- [Troubleshooting](#troubleshooting)

## Prerequisites

### For Android Development

- **Node.js** 20+ and npm
- **Java Development Kit (JDK)** 17
- **Android Studio** (latest version)
- **Android SDK** with API Level 33+
- **Gradle** (included with Android Studio)

### For iOS Development (macOS only)

- **Node.js** 20+ and npm
- **Xcode** 14+ (from Mac App Store)
- **CocoaPods** (`sudo gem install cocoapods`)
- **Apple Developer Account** ($99/year) for distribution

### Environment Variables

Create a `.env.mobile` file in `lia-front/` with your production backend URLs:

```env
VITE_BASE_API_URL=https://your-backend-url.com/
VITE_WS_URL=your-backend-url.com
VITE_PUBLIC_POSTHOG_KEY=your_posthog_key
VITE_PUBLIC_POSTHOG_HOST=https://eu.i.posthog.com
```

**Important:** The backend must be publicly accessible (not localhost).

## Project Structure

```
lia-front/
├── android/              # Android native project (generated by Capacitor)
├── ios/                  # iOS native project (generated by Capacitor)
├── dist/                 # Built web assets (generated by Vite)
├── src/                  # React source code
├── capacitor.config.ts   # Capacitor configuration
├── vite.config.ts        # Vite build configuration
└── package.json          # npm scripts for mobile builds
```

## Local Development

### Initial Setup

1. **Install dependencies:**
   ```bash
   cd lia-front
   npm install
   ```

2. **Build the web app for mobile:**
   ```bash
   npm run build:mobile
   ```

3. **Platforms are already initialized** (android/ and ios/ directories exist).
   If you need to reinitialize, run:
   ```bash
   npm run cap:init
   ```

### Android Development

1. **Sync changes to Android:**
   ```bash
   npm run cap:sync:android
   ```

2. **Open in Android Studio:**
   ```bash
   npm run cap:open:android
   ```

3. **Run on device/emulator:**
   - In Android Studio: Click the "Run" button (green play icon)
   - Or via CLI: `npm run cap:run:android`

4. **Debug:**
   - Open Chrome DevTools: `chrome://inspect`
   - Select your device/emulator

### iOS Development (macOS only)

1. **Install CocoaPods dependencies:**
   ```bash
   cd ios/App
   pod install
   cd ../..
   ```

2. **Sync changes to iOS:**
   ```bash
   npm run cap:sync:ios
   ```

3. **Open in Xcode:**
   ```bash
   npm run cap:open:ios
   ```

4. **Configure signing:**
   - In Xcode, select the project in the navigator
   - Select the "App" target
   - Go to "Signing & Capabilities"
   - Select your Team and ensure automatic signing is enabled

5. **Run on device/simulator:**
   - In Xcode: Select a target device and click the "Run" button
   - Or via CLI: `npm run cap:run:ios`

6. **Debug:**
   - In Xcode: Use the debug console
   - Safari DevTools: Develop → [Your Device] → localhost

## Building for Production

### Android Release Build

#### 1. Generate a Release Keystore (one-time setup)

```bash
cd android/app
keytool -genkey -v -keystore lia-release.keystore \
  -alias lia -keyalg RSA -keysize 2048 -validity 10000
```

Save the keystore file securely and remember the passwords.

#### 2. Configure Signing

Edit `android/app/build.gradle` and uncomment the signing configuration:

```gradle
signingConfigs {
    release {
        if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
            storeFile file(MYAPP_RELEASE_STORE_FILE)
            storePassword MYAPP_RELEASE_STORE_PASSWORD
            keyAlias MYAPP_RELEASE_KEY_ALIAS
            keyPassword MYAPP_RELEASE_KEY_PASSWORD
        }
    }
}

buildTypes {
    release {
        signingConfig signingConfigs.release
        // ...
    }
}
```

Create `android/gradle.properties` with:

```properties
MYAPP_RELEASE_STORE_FILE=lia-release.keystore
MYAPP_RELEASE_STORE_PASSWORD=your_store_password
MYAPP_RELEASE_KEY_ALIAS=lia
MYAPP_RELEASE_KEY_PASSWORD=your_key_password
```

#### 3. Build Release APK/AAB

```bash
cd android
./gradlew assembleRelease    # For APK
./gradlew bundleRelease       # For AAB (Google Play)
```

**Output:**
- APK: `android/app/build/outputs/apk/release/app-release.apk`
- AAB: `android/app/build/outputs/bundle/release/app-release.aab`

### iOS Release Build

#### 1. Configure Xcode Project

1. Open project in Xcode: `npm run cap:open:ios`
2. Select the "App" target
3. Update **Version** and **Build** numbers
4. Configure **Signing & Capabilities** with your Team and Provisioning Profile

#### 2. Create Archive

1. In Xcode: Product → Archive
2. Wait for the archive to complete
3. In the Organizer window, click "Distribute App"
4. Choose distribution method:
   - **App Store Connect** (for TestFlight and App Store)
   - **Ad Hoc** (for internal testing)
   - **Development** (for debugging)

#### 3. Upload to App Store Connect

1. Follow the Xcode prompts to upload
2. Or use Fastlane (recommended for automation)

## CI/CD Pipeline

### GitHub Actions Workflows

Two workflows are configured in `.github/workflows/`:

1. **`android-build.yml`** - Builds Android APK/AAB
2. **`ios-build.yml`** - Builds iOS IPA (requires macOS runner)

### Triggers

- **Tags:** `v*` (e.g., `v1.0.0`) → Production builds
- **Branches:** `main` → Debug builds
- **Pull Requests** → Validation builds
- **Manual:** Workflow dispatch

### Required GitHub Secrets

#### For Both Platforms

- `VITE_BASE_API_URL` - Production backend API URL
- `VITE_WS_URL` - Production WebSocket URL
- `VITE_PUBLIC_POSTHOG_KEY` - PostHog analytics key
- `VITE_PUBLIC_POSTHOG_HOST` - PostHog host URL

#### For Android

- `ANDROID_KEYSTORE_BASE64` - Base64-encoded keystore file
  ```bash
  base64 -i lia-release.keystore | pbcopy
  ```
- `ANDROID_STORE_PASSWORD` - Keystore password
- `ANDROID_KEY_ALIAS` - Key alias (usually "lia")
- `ANDROID_KEY_PASSWORD` - Key password

#### For iOS

- `IOS_CERTIFICATES_P12` - Base64-encoded .p12 certificate
- `IOS_CERTIFICATES_PASSWORD` - Certificate password
- `IOS_PROVISIONING_PROFILE` - Base64-encoded provisioning profile
- `APPSTORE_ISSUER_ID` - App Store Connect API issuer ID (optional)
- `APPSTORE_API_KEY_ID` - App Store Connect API key ID (optional)
- `APPSTORE_API_PRIVATE_KEY` - App Store Connect API private key (optional)

### Release Process

1. **Commit changes** and ensure tests pass
2. **Create a tag:**
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```
3. **GitHub Actions** automatically builds and uploads artifacts
4. **Download artifacts** from the Actions tab
5. **Upload to stores:**
   - Android: Upload AAB to Google Play Console
   - iOS: Upload IPA to App Store Connect (or use Fastlane)

## Available npm Scripts

```bash
# Build frontend for mobile
npm run build:mobile

# Sync all platforms
npm run cap:sync

# Sync specific platform
npm run cap:sync:android
npm run cap:sync:ios

# Open in IDE
npm run cap:open:android
npm run cap:open:ios

# Run on device
npm run cap:run:android
npm run cap:run:ios
```

## Troubleshooting

### Android

**Issue:** Gradle build fails with "SDK not found"
- **Solution:** Set `ANDROID_HOME` environment variable:
  ```bash
  export ANDROID_HOME=$HOME/Android/Sdk
  ```

**Issue:** "Cleartext HTTP traffic not permitted"
- **Solution:** Add `android:usesCleartextTraffic="true"` in `AndroidManifest.xml` (development only)

**Issue:** App crashes on startup
- **Solution:** Check logs: `adb logcat | grep Capacitor`

### iOS

**Issue:** "CocoaPods not installed"
- **Solution:** Install CocoaPods: `sudo gem install cocoapods`

**Issue:** "No provisioning profile found"
- **Solution:** Configure signing in Xcode under "Signing & Capabilities"

**Issue:** App crashes on device
- **Solution:** Check console in Xcode or Safari DevTools

### General

**Issue:** WebSocket connection fails
- **Solution:** Ensure `VITE_WS_URL` is correctly configured without protocol prefix

**Issue:** API requests fail (CORS errors)
- **Solution:** Configure CORS on your backend to accept requests from mobile apps

**Issue:** "dist/ directory not found"
- **Solution:** Run `npm run build:mobile` before syncing

## Backend Requirements

For the mobile apps to work, your backend must:

1. **Be publicly accessible** (not localhost)
2. **Use HTTPS** (recommended for production)
3. **Configure CORS** to accept mobile app requests
4. **Support WebSocket connections** for real-time features

Example Django CORS configuration:

```python
CORS_ALLOWED_ORIGINS = [
    "capacitor://localhost",
    "ionic://localhost",
    "http://localhost",
]
```

## Additional Resources

- [Capacitor Documentation](https://capacitorjs.com/docs)
- [Android Developer Guide](https://developer.android.com/guide)
- [iOS Developer Guide](https://developer.apple.com/documentation/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

## Support

For issues or questions, please refer to:
- Capacitor issues: https://github.com/ionic-team/capacitor/issues
- Project-specific issues: Create an issue in this repository
